<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Decap CMS OAuth Callback</title>
</head>
<body>
  <script>
  (function() {
    console.log("DEBUG: Callback script started.");

    function parseHash(hash) {
      console.log("DEBUG: Parsing hash:", hash);
      const params = new URLSearchParams(hash.substring(1)); // 移除开头的 '#'
      const data = {};
      for (const [key, value] of params.entries()) {
        data[key] = value;
      }
      console.log("DEBUG: Parsed data from hash:", data);
      return data;
    }

    // 关键检查：立即检查 window.opener 是否存在
    if (window.opener) {
      console.log("DEBUG: SUCCESS! window.opener is available.", window.opener);
      
      const data = parseHash(window.location.hash);
      let message;

      if (data.token) {
        console.log("DEBUG: Token found in hash.");
        message = 'authorization:github:success:' + JSON.stringify({
          token: data.token,
          provider: data.provider
        });
      } else {
        console.error("DEBUG: CRITICAL - Neither token nor error found in hash.");
        message = 'authorization:github:error:' + JSON.stringify({
          error: 'No token or error found in callback URL hash.'
        });
      }
      
      const targetOrigin = window.location.origin;
      console.log(`DEBUG: Attempting to send message to parent...`, {
          message: message,
          targetOrigin: targetOrigin
      });

      // 发送消息
      window.opener.postMessage(message, targetOrigin);
      
      console.log("DEBUG: Message has been sent. Window should close automatically if successful.");

    } else {
      console.error("DEBUG: CRITICAL - window.opener is NULL or not available.");
      document.body.innerHTML = '<h1>错误: 找不到父窗口</h1><p>这可能是由于浏览器的安全设置。请关闭此窗口并重试。</p>';
    }
  })();
  </script>
  正在验证, 请稍候...
</body>
</html>