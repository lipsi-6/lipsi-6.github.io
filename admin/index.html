<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的简易编辑器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 15px; background: #f4f7f6; }
        div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 12px;
            box-sizing: border-box; /* 关键，使padding不影响宽度 */
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }
        textarea { height: 400px; font-family: monospace; }
        button {
            background: #007bff; color: white; padding: 12px 18px;
            border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        #postList { max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        #postList div { cursor: pointer; padding: 8px; border-bottom: 1px solid #eee; }
        #postList div:hover { background: #f0f0f0; }
        #postList div:last-child { border-bottom: none; }
        #loginArea, #editorArea { padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        #message { margin-top: 15px; padding: 10px; border-radius: 8px; }
        #message.success { background: #e6ffed; color: #006622; }
        #message.error { background: #ffe6e6; color: #cc0000; }
    </style>
</head>
<body>

    <div id="loginArea">
        <h2>登录</h2>
        <label for="password">密码:</label>
        <input type="password" id="password" onkeydown="if(event.key==='Enter') login()">
        <button onclick="login()">登录</button>
    </div>

    <div id="editorArea" style="display: none;">
        <h2>我的简易编辑器</h2>

        <div>
            <label>编辑旧文章:</label>
            <div id="postList">正在加载...</div>
            <button class="secondary" onclick="clearEditor()" style="margin-top: 10px;">+ 写新文章</button>
        </div>

        <div>
            <label for="title">标题:</label>
            <input type="text" id="title" placeholder="文章标题">
        </div>
        
        <div>
            <label for="category">分类 (Category):</label>
            <select id="category"></select>
            </div>

        <div>
            <label for="tags">标签 (Tags):</label>
            <input type="text" id="tags" placeholder="标签, 用英文逗号分隔">
        </div>

        <div>
            <label for="content">正文 (Markdown):</label>
            <textarea id="content" placeholder="在这里写..."></textarea>
        </div>

        <button onclick="publish()">发布</button>
        <div id="message"></div>
        
        <input type="hidden" id="editingPath">
        <input type="hidden" id="editingSha">
    </div>


    <script>
        // --- 配置 ---
        const API_URL = 'https://tight-fire-d82e.3zhml-z2mo-0ed.workers.dev'; // 你的 Worker 域名
        let MY_PASSWORD = ''; // 登录后存储

        // --- DOM 元素 ---
        const $ = el => document.getElementById(el);
        const loginArea = $('loginArea');
        const editorArea = $('editorArea');
        const messageDiv = $('message');

        // --- 登录逻辑 ---
        function login() {
            const pass = $('password').value;
            fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pass })
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.message || '密码错误'); });
                }
                return res.json();
            })
            .then(data => {
                MY_PASSWORD = pass; // 存储密码，用于后续请求
                sessionStorage.setItem('my_blog_pass', pass); // 存储在 session
                loginArea.style.display = 'none';
                editorArea.style.display = 'block';
                // 登录成功后，加载数据
                loadTaxonomy();
                loadPostList();
            })
            .catch(err => {
                showMessage(err.message, 'error');
            });
        }
        
        // --- 检查 Session 登录 ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedPass = sessionStorage.getItem('my_blog_pass');
            if (storedPass) {
                $('password').value = storedPass;
                login();
            }
        });
        
        // --- 封装的 fetch ---
        async function apiFetch(endpoint, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            options.headers['Authorization'] = `Bearer ${MY_PASSWORD}`;
            if (options.body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            const res = await fetch(`${API_URL}${endpoint}`, options);
            
            if (res.status === 401) {
                sessionStorage.removeItem('my_blog_pass');
                loginArea.style.display = 'block';
                editorArea.style.display = 'none';
                throw new Error('授权失败，请重新登录');
            }
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.message || `API Error: ${res.statusText}`);
            }
            return res.json();
        }
        
        function showMessage(msg, type = 'success') {
            messageDiv.textContent = msg;
            messageDiv.className = type;
        }


        // --- 加载数据 ---
        function loadTaxonomy() {
            apiFetch('/taxonomy')
                .then(data => {
                    const catSelect = $('category');
                    catSelect.innerHTML = '<option value="">--选择分类--</option>';
                    (data.categories || []).forEach(cat => {
                        catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                })
                .catch(err => console.error('Error loading taxonomy:', err));
        }

        function loadPostList() {
            const listDiv = $('postList');
            listDiv.innerHTML = '正在加载...';
            apiFetch('/posts')
                .then(data => {
                    listDiv.innerHTML = '';
                    data.forEach(post => {
                        const postEl = document.createElement('div');
                        postEl.textContent = post.name;
                        postEl.onclick = () => loadPostContent(post.path);
                        listDiv.appendChild(postEl);
                    });
                })
                .catch(err => {
                    listDiv.innerHTML = '加载失败';
                    console.error('Error loading posts:', err)
                });
        }
        
        // --- 编辑逻辑 ---
        function loadPostContent(path) {
            clearEditor(false); // 清空但不清空消息
            showMessage('正在加载文章...', 'success');
            apiFetch(`/post_content?path=${encodeURIComponent(path)}`)
                .then(data => {
                    const fm = data.front_matter || {};
                    $('title').value = fm.title || '';
                    $('category').value = fm.category || '';
                    $('tags').value = (fm.tags || []).join(', ');
                    $('content').value = data.content || '';
                    
                    $('editingPath').value = path;
                    $('editingSha').value = data.sha;
                    showMessage(`正在编辑: ${path}`, 'success');
                })
                .catch(err => {
                    showMessage(`加载失败: ${err.message}`, 'error');
                });
        }
        
        function clearEditor(clearMsg = true) {
            $('title').value = '';
            $('category').value = '';
            $('tags').value = '';
            $('content').value = '';
            $('editingPath').value = '';
            $('editingSha').value = '';
            if (clearMsg) showMessage('', 'success');
        }

        // --- 发布逻辑 ---
        function publish() {
            showMessage('正在发布...', 'success');

            const payload = {
                title: $('title').value,
                content: $('content').value,
                category: $('category').value,
                tags: $('tags').value.split(',').map(t => t.trim()).filter(Boolean),
            };
            
            const existingPath = $('editingPath').value;
            const sha = $('editingSha').value;
            
            if (existingPath && sha) {
                payload.existing_path = existingPath;
                payload.sha = sha;
            }

            apiFetch('/publish', {
                method: 'POST',
                body: payload
            })
            .then(data => {
                showMessage(`发布成功! (${data.path})`, 'success');
                clearEditor(false);
                loadPostList(); // 刷新文章列表
            })
            .catch(err => {
                showMessage(`发布失败: ${err.message}`, 'error');
            });
        }
    </script>
</body>
</html>